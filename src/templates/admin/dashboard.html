{% extends 'admin/master.html' %}

{% block body %}
<div class="container-fluid" style="margin-top:10px;">
    <h3 style="margin-bottom:15px;"><b>RESUMEN:</b></h3>
    <form method="get" data-pjax="false" style="margin-bottom:15px;">
        <select name="year">
            <option value="{{ current_year }}" {% if selected_year==current_year %}selected{% endif %}>
                {{ current_year }}
            </option>
            <option value="2025" {% if selected_year==2025 %}selected{% endif %}>
                2025
            </option>
        </select>

        <button type="submit" class="btn btn-light btn-sm" style="margin-left:5px;">
            Ver
        </button>
    </form>
    <div class="row">
        <div class="col-md-12 col-sm-12">
            <div class="panel panel-success">
                <div class="panel-heading">Ingresos mes en curso</div>
                <div class="panel-body">
                    <h3 style="display:inline-block; margin:0;">
                        <b><b>{{ "%.2f"|format(metrics.ingresos_mes_actual) }}‚Ç¨</b></b>
                    </h3>
                    <small style="display:inline-block; margin-left:10px;">
                        {% if metrics.variacion_es_nueva %}
                        <span style="color:green;">‚ñ≤ {{ metrics.variacion_label }}</span>
                        <span class="text-muted"> (sin periodo anterior)</span>
                        {% else %}
                        {% if metrics.variacion_up %}
                        <span style="color:green;">‚ñ≤ {{ metrics.variacion_label }}</span>
                        {% else %}
                        <span style="color:red;">‚ñº {{ metrics.variacion_label }}</span>
                        {% endif %}
                        respecto al mes anterior
                        {% endif %}

                    </small>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-success">
                <div class="panel-heading">
                    <b>Facturaci√≥n vs Punto Muerto</b>
                </div>
                <div class="panel-body">

                    <h4 style="margin-top:0;">
                        {{ "%.2f"|format(break_even_kpi.revenue_current_month) }} ‚Ç¨
                        <small class="text-muted">/ {{ "%.2f"|format(break_even_kpi.break_even_monthly) }} ‚Ç¨</small>
                    </h4>

                    {% if break_even_kpi.status == "FRENAR" %}
                    <span class="label label-danger">FRENAR</span>
                    <p class="text-muted" style="margin-top:8px;">
                        Est√°s muy por debajo del punto muerto.
                        Prioriza liquidez, reduce gasto y no escales.
                    </p>

                    {% elif break_even_kpi.status == "MANTENER" %}
                    <span class="label label-warning">MANTENER</span>
                    <p class="text-muted" style="margin-top:8px;">
                        Cerca del equilibrio. Mant√©n el ritmo y optimiza conversi√≥n.
                    </p>

                    {% else %}
                    <span class="label label-success">APRETAR</span>
                    <p class="text-muted" style="margin-top:8px;">
                        Cubres costes. Buen momento para invertir o empujar ventas.
                    </p>
                    {% endif %}

                    <p style="margin-top:10px;">
                        Diferencia:
                        <b>
                            {{ "%.2f"|format(break_even_kpi.difference) }} ‚Ç¨
                        </b>
                    </p>

                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-3">
            <div class="panel panel-primary">
                <div class="panel-heading">Productos</div>
                <div class="panel-body"><strong>{{ metrics.products_count }}</strong></div>
            </div>
        </div>
        <div class="col-sm-3">
            <div class="panel panel-primary">
                <div class="panel-heading">Pedidos</div>
                <div class="panel-body"><strong>{{ metrics.orders_count }}</strong></div>
            </div>
        </div>
        <div class="col-sm-3">
            <div class="panel panel-primary">
                <div class="panel-heading">Facturas</div>
                <div class="panel-body"><strong>{{ metrics.invoices_count }}</strong></div>
            </div>
        </div>
        <div class="col-sm-3">
            <div class="panel panel-primary">
                <div class="panel-heading">Usuarios</div>
                <div class="panel-body"><strong>{{ metrics.users_count }}</strong></div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    Ventas {{ selected_year }}
                </div>
                <div class="panel-body">
                    <canvas id="salesChart-{{ selected_year }}" style="width:100%; min-height:300px;"
                        data-labels='{{ monthly_sales_labels | tojson }}'
                        data-values='{{ monthly_sales_values | tojson }}'>
                    </canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    Usuarios nuevos {{ selected_year }}
                </div>
                <div class="panel-body">
                    <canvas id="usersChart-{{ selected_year }}" style="width:100%; min-height:300px;"
                        data-labels='{{ monthly_sales_labels | tojson }}'
                        data-values='{{ users_monthly_values | tojson }}'>
                    </canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6 col-sm-12">
            <div class="panel panel-primary">
                <div class="panel-heading">√öltimos pedidos</div>
                <div class="panel-body" style="padding:0;">
                    <div class="table-responsive"> <!-- üî• Scroll horizontal en m√≥vil -->
                        <table class="table table-striped" style="margin:0;">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Fecha</th>
                                    <th>Estado</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for o in recent_orders %}
                                <tr>
                                    <td>{{ (o.user.email if o.user else '‚Äî') }}</td>
                                    <td>{{ tz_es(o.order_date) if o.order_date else '' }}</td>
                                    <td>{{ o.order_status }}</td>
                                    <td>{{ "{:.2f}".format(o.total_amount or 0) }}‚Ç¨</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="5" class="text-muted">Sin datos</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-sm-12">
            <div class="panel panel-primary">
                <div class="panel-heading">√öltimas facturas</div>
                <div class="panel-body" style="padding:0;">
                    <div class="table-responsive"> <!-- üî• Scroll horizontal en m√≥vil -->
                        <table class="table table-striped" style="margin:0;">
                            <thead>
                                <tr>
                                    <th>Nro. Factura</th>
                                    <th>Cliente</th>
                                    <th>Importe</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for f in recent_invoices %}
                                <tr>
                                    <td>{{ f.invoice_number }}</td>
                                    <td>{{ f.client_name or '‚Äî' }}</td>
                                    <td>{{ "{:.2f}".format(f.amount or 0) }}‚Ç¨</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="4" class="text-muted">Sin datos</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="panel panel-primary">
                <div class="panel-heading">Ticket medio</div>
                <div class="panel-body">
                    <h3><b>{{ "%.2f"|format(metrics.avg_ticket) }}‚Ç¨</b></h3>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/chart.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/admin_sales_chart.js') }}"></script>
<script src="{{ url_for('static', filename='js/admin_users_chart.js') }}"></script>

{% endblock %}